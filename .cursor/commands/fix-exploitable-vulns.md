# Fix Exploitable Vulnerabilities

## Overview

Fix CISA Known Exploited Vulnerabilities (KEV) if exists in your codebase. Search for vulnerabilities that are listed in the CISA Known Exploited Vulnerabilities (KEV) catalog using Trivy filesystem scanning. If any of these vulnerabilities are found, fix them by the CVE notes.

## Steps

1. **Trivy Filesystem Scan**
    - Use only Trivy filesystem scanning via the aquasecurity/trivy-action GitHub Action
    - Do not integrate with other security tools
    - Configure Trivy to scan the filesystem for vulnerabilities
    - Ensure output is in JSON format and saved for the next steps

2. **CISA KEV Catalog Download**
    - Create a step that downloads the CISA KEV catalog in JSON format
    - Use URL: https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json

3. **Vulnerability Matching**
    - Parse the Trivy JSON output to extract CVE IDs
    - Match CVE IDs from Trivy output with the CISA KEV catalog
    - Use CVE ID from Trivy output to match it with the CISA KEV catalog
    - If CVE ID is found in the catalog, the CI/CD should fail and block the commit

4. **Logging and Reporting**
    - Add detailed logs showing the number of vulnerabilities found
    - Display vulnerability details including:
        - CVE ID
        - CISA Details (Vendor, Product, Vulnerability Name, Due Date, Required Action)
        - Affected Packages (Package Name, Current Version, Fixed Version, Severity, Description)
    - Show user confidence that the workflow is working
5. **Fix Vulnerabilities**
    - Use the notes section in the downloaded URL to find out specific info about the vulnerability
    - Fix it accordingly

## Example Script

Here is an example of a working script that can achieve this:

```bash
#!/bin/bash

set -e

TARGET="${1:-./}"
TRIVY_OUTPUT="/tmp/trivy-results.json"
CISA_KEV_URL="https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json"
CISA_KEV_FILE="/tmp/cisa-kev.json"

echo "Running Trivy scan on target: $TARGET"
trivy fs --format json --output "$TRIVY_OUTPUT" "$TARGET"

echo "Fetching CISA Known Exploited Vulnerabilities catalog..."
curl -s "$CISA_KEV_URL" -o "$CISA_KEV_FILE"

echo "Checking for exploited vulnerabilities..."

exploited_found=false
exploited_packages=()

trivy_cves=$(jq -r '.Results[]?.Vulnerabilities[]?.VulnerabilityID // empty' "$TRIVY_OUTPUT" 2>/dev/null | sort -u)

if [ -z "$trivy_cves" ]; then
    echo "No vulnerabilities found by Trivy"
    exit 0
fi

echo "Found $(echo "$trivy_cves" | wc -l) unique CVEs in Trivy results"
echo ""

for cve in $trivy_cves; do
    kev_details=$(jq --arg cve "$cve" '.vulnerabilities[] | select(.cveID == $cve)' "$CISA_KEV_FILE" 2>/dev/null)

    if [ -n "$kev_details" ]; then
        echo "ðŸš¨ EXPLOITED VULNERABILITY FOUND: $cve"
        echo "   CISA Details:"
        echo "   - Vendor: $(echo "$kev_details" | jq -r '.vendorProject // "N/A"')"
        echo "   - Product: $(echo "$kev_details" | jq -r '.product // "N/A"')"
        echo "   - Vulnerability: $(echo "$kev_details" | jq -r '.vulnerabilityName // "N/A"')"
        echo "   - Due Date: $(echo "$kev_details" | jq -r '.dueDate // "N/A"')"
        echo "   - Required Action: $(echo "$kev_details" | jq -r '.requiredAction // "N/A"')"
        echo ""

        # Get package details from Trivy results
        package_details=$(jq --arg cve "$cve" '
            .Results[]? |
            select(.Vulnerabilities) |
            {
                Target: .Target,
                Class: .Class,
                Type: .Type,
                Packages: [
                    .Vulnerabilities[] |
                    select(.VulnerabilityID == $cve) |
                    {
                        PkgName: .PkgName,
                        InstalledVersion: .InstalledVersion,
                        FixedVersion: .FixedVersion,
                        Severity: .Severity,
                        Title: .Title
                    }
                ]
            } |
            select(.Packages | length > 0)
        ' "$TRIVY_OUTPUT" 2>/dev/null)

        if [ -n "$package_details" ]; then
            echo "   ðŸ“¦ Affected Packages:"
            echo "$package_details" | jq -r '
                "   Target: " + .Target + " (" + .Type + ")",
                (.Packages[] |
                    "   - Package: " + .PkgName +
                    "\n     Current Version: " + .InstalledVersion +
                    "\n     Fix Available: " + (.FixedVersion // "Not specified") +
                    "\n     Severity: " + .Severity +
                    "\n     Description: " + (.Title // "N/A")
                )
            '
        fi

        echo "----------------------------------------"
        exploited_found=true
    fi
done

if [ "$exploited_found" = true ]; then
    echo ""
    echo "CRITICAL: Found vulnerabilities in CISA Known Exploited Vulnerabilities catalog"
    echo "   These vulnerabilities are actively being exploited in the wild!"
    echo "   Immediate action required - update the affected packages above."
    exit 1
else
    echo "No exploited vulnerabilities found"
    exit 0
fi
```

## Fix Exploitable Vulnerabilities Checklist

- [ ] Performed Trivy filesystem scan
- [ ] Downloaded CISA KEV catalog
- [ ] Matched CVE IDs from Trivy output with CISA KEV catalog
- [ ] Identified exploited vulnerabilities in codebase
- [ ] Logged vulnerability details (CVE ID, CISA details, affected packages)
- [ ] Reviewed CISA notes for vulnerability-specific information
- [ ] Fixed identified vulnerabilities
- [ ] Verified fixes by re-running Trivy scan
